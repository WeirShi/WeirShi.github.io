(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{371:function(t,s,n){"use strict";n.r(s);var a=n(45),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"js中的eventloop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#js中的eventloop"}},[t._v("#")]),t._v(" JS中的EventLoop")]),t._v(" "),n("h2",{attrs:{id:"浏览器中的eventloop"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器中的eventloop"}},[t._v("#")]),t._v(" 浏览器中的EventLoop")]),t._v(" "),n("ol",[n("li",[n("p",[t._v("JS是单线程的，比如在操作Dom的时候，不能删除一个Dom节点的同时再去操作同一个Dom节点。或者在进行一个网络请求的时候，我们往往需要等待这个请求完成之后才能对请求回来的数据进行Dom的渲染。"),n("br"),t._v("\n那浏览器到底是如何协调这些事件、交互的呢？这个时候就要用到EventLoop-事件循环机制了。")])]),t._v(" "),n("li",[n("p",[t._v("任务队列")])])]),t._v(" "),n("ul",[n("li",[t._v("JS中有个任务队列的概念")]),t._v(" "),n("li",[t._v("JS中将任务主要分为宏任务(macrotask)和微任务(microtask)\n"),n("ul",[n("li",[t._v("宏任务(macrotask): script脚本，request回调，event事件回调，setTimeour, setInterval, setImmediate(node环境)、I/O、UI rendering")]),t._v(" "),n("li",[t._v("微任务(microtask): Promise，process.nextTick(node)")])])])]),t._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[t._v("执行步骤")])]),t._v(" "),n("ul",[n("li",[t._v("同一个上下文中，执行顺序是同步代码 -> 微任务 -> 宏任务")])]),t._v(" "),n("h2",{attrs:{id:"代码解析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码解析"}},[t._v("#")]),t._v(" 代码解析")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timer1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise start"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timer2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"promise2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"end"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 浏览器输出")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// start")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// end")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timer1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// promise start")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// promise1")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timer2")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// promise2")]),t._v("\n")])])]),n("p",[t._v("结果分析："),n("br"),t._v("\n在同一个上下文中，从上到下依次执行，首先遇到"),n("code",[t._v('console.log("start")')]),t._v("同步代码，先执行同步代码，所以第一个输出"),n("code",[t._v("start")]),t._v("，向下遇到第一个"),n("code",[t._v("setTimeout")]),t._v("为宏任务，塞进宏任务队列，第二个"),n("code",[t._v("setTimeout")]),t._v("同理，最后又遇到"),n("code",[t._v('console.log("end")')]),t._v("同步代码，执行并输入"),n("code",[t._v("end")]),t._v("。"),n("br"),t._v("\n同步任务完成后，JS执行栈为空，检查微任务也为空，检查宏任务中存在需要执行的任务，所以按先进先出的规则执行宏任务队列，首先执行第一个"),n("code",[t._v("setTimeout")]),t._v("，进来首先是"),n("code",[t._v('console.log("timer1")')]),t._v("同步代码，所以执行并输入"),n("code",[t._v("timer1")]),t._v("，然后执行"),n("code",[t._v("new Promise")]),t._v(", "),n("code",[t._v("new Promise")]),t._v("中首先是"),n("code",[t._v('console.log("promise start")')]),t._v("，输出"),n("code",[t._v("promise start")]),t._v("，接着执行了"),n("code",[t._v("resolve")]),t._v(", "),n("code",[t._v("Promise.then")]),t._v("同样属于微任务，塞入微任务中挂起。这一轮宏任务执行完成，检查微任务，存在"),n("code",[t._v("Promise.then")]),t._v(",执行并输出"),n("code",[t._v("promise1")]),t._v("。\n执行完成后，JS执行栈为空，继续查找宏任务，执行第二个"),n("code",[t._v("setTimeout")]),t._v("，输出"),n("code",[t._v("timer2")]),t._v("，遇到"),n("code",[t._v("Promise.resolve.then")]),t._v("微任务，塞入微任务挂起，"),n("code",[t._v("setTimeout")]),t._v("执行完成，检查微任务,执行输出"),n("code",[t._v("promise2")]),t._v("。")]),t._v(" "),n("h2",{attrs:{id:"async-await"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#async-await"}},[t._v("#")]),t._v(" async/await")]),t._v(" "),n("p",[n("code",[t._v("async/await")]),t._v(" 是ES7中推出的语法糖，是针对ES6"),n("code",[t._v("generate/yield")]),t._v("的语法糖，"),n("code",[t._v("async")]),t._v("返回的同样是一个Promise对象，遇到"),n("code",[t._v("await")]),t._v("就会等待异步操作完成，再继续执行后面的语句。"),n("strong",[t._v("注意："),n("code",[t._v("await")]),t._v("命令后面的"),n("code",[t._v("Promise")]),t._v("对象，运行结果可能是"),n("code",[t._v("rejected")]),t._v("，所以最好把"),n("code",[t._v("await")]),t._v("命令放在"),n("code",[t._v("try...catch")]),t._v("代码块中。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);